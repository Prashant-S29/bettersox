name: Cron Jobs

on:
  # schedule:
  #   - cron: '*/5 * * * *'
  workflow_dispatch:  

jobs:
  check-trackers:
    runs-on: ubuntu-latest
    steps:
      - name: Determine environment URL
        id: env
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "url=https://bettersox.vercel.app" >> $GITHUB_OUTPUT
            echo "env_name=Production" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/heads/staging" ]]; then
            echo "url=https://bettersox-staging.vercel.app" >> $GITHUB_OUTPUT
            echo "env_name=Staging" >> $GITHUB_OUTPUT
          else
            echo "url=https://bettersox-staging.vercel.app" >> $GITHUB_OUTPUT
            echo "env_name=Preview (staging)" >> $GITHUB_OUTPUT
          fi
      
      - name: Trigger check-trackers endpoint (${{ steps.env.outputs.env_name }})
        run: |
          echo "Calling: ${{ steps.env.outputs.url }}/api/cron/check-trackers"
          curl -X GET "${{ steps.env.outputs.url }}/api/cron/check-trackers" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            -H "x-vercel-protection-bypass: ${{ secrets.VERCEL_PROTECTION_BYPASS }}" \
            -f || exit 1

  send-emails:
    runs-on: ubuntu-latest
    needs: check-trackers
    steps:
      - name: Determine environment URL
        id: env
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "url=https://bettersox.vercel.app" >> $GITHUB_OUTPUT
            echo "env_name=Production" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/heads/staging" ]]; then
            echo "url=https://bettersox-staging.vercel.app" >> $GITHUB_OUTPUT
            echo "env_name=Staging" >> $GITHUB_OUTPUT
          else
            echo "url=https://bettersox-staging.vercel.app" >> $GITHUB_OUTPUT
            echo "env_name=Preview (staging)" >> $GITHUB_OUTPUT
          fi
      
      - name: Wait 2 minutes before sending emails
        run: sleep 120
        
      - name: Trigger send-email endpoint (${{ steps.env.outputs.env_name }})
        run: |
          echo "Calling: ${{ steps.env.outputs.url }}/api/queue/send-email"
          curl -X GET "${{ steps.env.outputs.url }}/api/queue/send-email" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            -H "x-vercel-protection-bypass: ${{ secrets.VERCEL_PROTECTION_BYPASS }}" \
            -f || exit 1